# TODO

- [ ] Patchelf support
  - Either use patchelf as subprocess or a crate like `object` to look at all
    linked objects, find the ones not in /nix/store and patch them to their
    canonical path.
  - Reason is source is symlinked in by nix-ninja-task so it gets linked
    against symlinks even though the .so files are in /nix/store
  - Unwise to try to detect linking rule and modify inputs at the ninja build
    graph layer.
- [ ] Move away from LazyBuild n2 branch
  - Did a bunch of work to make n2 lazy evaluate the graph to allow me to
    modify $in and $out the rule evaluates against. E.g. change $in and $out to
    refer to /nix/store paths.
  - Turned out to be the wrong approach as there are custom targets generated
    by meson that just don't use $in and $out in practice.
  - Only fool proof way is to source symlink in, and copy outputs into
    content-addressed output placeholders after
- [ ] Phony target support
  - DerivedFile has name: Option<String> again
  - Move symlinking logic to method under DerivedFile
  - If symlink source is directory, walk dir and symlink to dest as prefix
  - Virtual targets e.g. if user inputs list of targets
- [ ] Depfile support
  - If depfile defined, add that as an additional output
  - Create virtual target of all depfiles to install locally into builddir
  - Read depfile to skip dep_infer if depfile exists
- [ ] mkMesonPackage do configure caching
  - Separate out configure and build into two derivations
  - Put source into one output path
  - Put build_dir_inputs into one output path
- [ ] Writing derivation caching for local mode
  - Need to adopt something similar to n2's db or ninja's deps cache
  - Scheduler needs to do mtime dirtying to write derivations
- [ ] Dynamic derivation to infer dependencies
  - Support dep_infer for SingleDerivedPathBuilt, i.e. .cc files that were
    generated by another derivation.
- [ ] Make `nix store add` async, probably biggest perf bottleneck
- [ ] Add github actions CI
- [ ] Add benchmarks for generating derivations
- [ ] Add benchmarks for end-to-end compilation of NixOS/Nix, for perf work
  upstream.
